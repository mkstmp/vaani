<div class="bg-white rounded-2xl shadow-xl p-6">
  <h2 class="text-2xl font-bold text-indigo-700 mb-4">ðŸŽ¤ Record Audio</h2>

  <form id="upload-form" class="flex flex-col space-y-4">
    <label class="text-gray-700">Text to record:</label>
    <input type="text" name="text" id="textField" value="{{ next_text.text if next_text else '' }}"
           class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-400" required>
    {% if next_text %}
      <input type="hidden" id="textId" name="text_id" value="{{ next_text.id }}">
    {% endif %}

    <div class="flex justify-center space-x-4">
      <button id="start" type="button" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg">Start</button>
      <button id="stop" type="button" class="bg-red-400 text-white py-2 px-4 rounded-lg" disabled>Stop</button>
      <button id="skipButton" type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg">Skip</button>
    </div>

    <audio id="audio" controls class="w-full rounded-lg shadow"></audio>

    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg">Upload</button>
    <p id="status" class="text-sm text-gray-600 text-center"></p>
  </form>

  <script>
    let mediaRecorder, chunks = [];

    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const skipBtn = document.getElementById('skipButton');
    const audioEl = document.getElementById('audio');
    const statusEl = document.getElementById('status');

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        audioEl.src = URL.createObjectURL(blob);
        audioEl.dataset.blob = blob;
      };
      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    skipBtn.onclick = async () => {
      const res = await fetch('/next-text');
      const data = await res.json();
      if (data.text) {
        document.getElementById('textField').value = data.text;
        document.getElementById('textId').value = data.id;
      } else {
        statusEl.textContent = 'âœ… All texts recorded!';
      }
    };

    document.getElementById('upload-form').onsubmit = async (e) => {
      e.preventDefault();
      const blob = audioEl.dataset.blob;
      if (!blob) {
        alert('Please record audio first.');
        return;
      }
      const formData = new FormData();
      formData.append("file", blob, "recording.webm");
      formData.append("text", document.getElementById("textField").value);
      formData.append("text_id", document.getElementById("textId").value);
      statusEl.textContent = "Uploading...";
      const res = await fetch("/upload-audio/", { method: "POST", body: formData });
      const result = await res.json();
      statusEl.textContent = "âœ… Uploaded successfully!";
    };
  </script>
</div>
