<div class="record-container relative bg-white rounded-2xl shadow-xl p-6">
  <h2 class="text-2xl font-bold text-indigo-700 mb-4">ü™∑ Add Vaani</h2>

  <div class="flex items-center gap-3 mb-3">
    <label for="text" class="text-gray-600 font-medium whitespace-nowrap">Text:</label>
    <input id="text" type="text"
           class="border flex-1 p-2 rounded"
           value="{{ next_text.text if next_text else '' }}"
           placeholder="Enter text..." />
    <input id="text_id" type="hidden" value="{{ next_text.id if next_text else '' }}">
  </div>

  <audio id="audioPlayback" controls class="mt-2 w-full hidden"></audio>

  <div class="flex justify-center gap-4 mt-4">
    <button id="recordBtn"
            class="bg-indigo-600 text-white px-6 py-2 rounded-full flex items-center gap-2 transition-all duration-300 hover:scale-105">
      üéôÔ∏è <span>Record</span>
    </button>

    <button id="uploadBtn"
            class="bg-green-600 text-white px-6 py-2 rounded-full flex items-center gap-2 transition-all duration-300 hover:scale-105 disabled:opacity-50"
            disabled>
      ‚¨ÜÔ∏è <span>Add</span>
    </button>
  </div>

  <div id="statusOverlay"
       class="absolute inset-0 bg-gray-100 bg-opacity-70 flex items-center justify-center text-lg text-indigo-600 font-semibold hidden animate-pulse">
    Uploading‚Ä¶
  </div>

  <style>
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.2); }
    }
    .recording {
      background-color: #ef4444 !important;
      animation: pulse-glow 1s infinite;
    }
  </style>

  <script>
    let mediaRecorder, chunks = [], isRecording = false, recordedBlob = null;
    const recordBtn = document.getElementById("recordBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const audioPlayback = document.getElementById("audioPlayback");
    const overlay = document.getElementById("statusOverlay");

    recordBtn.onclick = async () => {
      if (!isRecording) {
        // Start recording
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.start();
        isRecording = true;

        recordBtn.classList.add("recording");
        recordBtn.querySelector("span").innerText = "Stop";

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
          recordedBlob = new Blob(chunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(recordedBlob);
          audioPlayback.src = url;
          audioPlayback.classList.remove("hidden");
          uploadBtn.disabled = false;
        };
      } else {
        // Stop recording (and allow rerecord)
        mediaRecorder.stop();
        recordBtn.classList.remove("recording");
        recordBtn.querySelector("span").innerText = "Record";
        isRecording = false;
      }
    };

    uploadBtn.onclick = async () => {
      if (!recordedBlob) return alert("Please record first!");
      overlay.textContent = "Uploading‚Ä¶";
      overlay.classList.remove("hidden");

      const formData = new FormData();
      formData.append("file", recordedBlob, "recording.webm");
      formData.append("text", document.getElementById("text").value);
      formData.append("text_id", document.getElementById("text_id").value);

      try {
        const res = await fetch("/upload-audio/", { method: "POST", body: formData });
        if (res.ok) {
          overlay.textContent = "Uploaded ‚úÖ";
          setTimeout(() => overlay.classList.add("hidden"), 800);
          await fetchNextText();
          audioPlayback.classList.add("hidden");
          uploadBtn.disabled = true;
          recordedBlob = null;
        } else throw new Error();
      } catch {
        overlay.textContent = "‚ùå Upload failed";
        setTimeout(() => overlay.classList.add("hidden"), 1500);
      }
    };

    async function fetchNextText() {
      const res = await fetch("/next-text");
      const data = await res.json();
      document.getElementById("text").value = data.text || "All recordings complete!";
      document.getElementById("text_id").value = data.id || "";
    }
  </script>
</div>
